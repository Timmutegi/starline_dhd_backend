events {
    worker_connections 1024;
}

http {
    upstream backend {
        server backend:8000;
    }

    # Rate limiting zones
    limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=api:10m rate=200r/m;

    # Security headers (CloudFront will handle HSTS)
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https: https://cdn.jsdelivr.net;" always;

    # Main server block - HTTP only (CloudFront handles HTTPS)
    server {
        listen 80;
        server_name _;

        # GZIP compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml text/x-js text/x-cross-domain-policy application/x-font-ttf application/x-font-opentype application/vnd.ms-fontobject image/x-icon;

        # Client max body size for file uploads
        client_max_body_size 100M;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Proxy headers for CloudFront
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Forwarded-Host $host;

        # Health check endpoint (no rate limiting)
        location /health {
            proxy_pass http://backend;
            access_log off;
        }

        # Auth endpoints with stricter rate limiting
        location /api/v1/auth/ {
            limit_req zone=auth burst=20 nodelay;
            limit_req_status 429;
            proxy_pass http://backend;
        }

        # API endpoints with standard rate limiting
        location /api/ {
            limit_req zone=api burst=100 nodelay;
            limit_req_status 429;
            proxy_pass http://backend;
        }

        # Documentation endpoints
        location /docs {
            proxy_pass http://backend;
        }

        location /redoc {
            proxy_pass http://backend;
        }

        location /openapi.json {
            proxy_pass http://backend;
        }

        # Static files with caching
        location /static/ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            proxy_pass http://backend;
        }

        # Root path
        location / {
            proxy_pass http://backend;
        }

        # Custom error responses
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;

        location = /404.html {
            internal;
            default_type application/json;
            return 404 '{"error": "Not Found", "status_code": 404}';
        }

        location = /50x.html {
            internal;
            default_type application/json;
            return 500 '{"error": "Internal Server Error", "status_code": 500}';
        }
    }
}